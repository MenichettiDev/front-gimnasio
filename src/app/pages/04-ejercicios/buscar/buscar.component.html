<div class="buscar-container">
    <p-toast></p-toast>
    <p-confirmDialog header="Confirmación" icon="pi pi-exclamation-triangle"></p-confirmDialog>
    <p-progressSpinner *ngIf="loading" [style]="{'width': '50px', 'height': '50px'}"></p-progressSpinner>

    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-search"></i>
            Buscar Ejercicios
        </h1>
        <p class="page-subtitle">
            Encuentra ejercicios específicos por grupo muscular y visualiza toda su información
        </p>
    </div>

    <div class="content-section">
        <h2 class="section-title">
            <i class="fas fa-filter"></i>
            Filtros de Búsqueda
        </h2>

        <form [formGroup]="exerciseForm" (ngSubmit)="onBuscar()">
            <!-- Grupo Muscular -->
            <div class="mb-3">
                <app-cbo-gruposmusculares formControlName="idGrupoMuscular"
                    (valueChange)="onGrupoMuscularChange($event)"></app-cbo-gruposmusculares>
            </div>

            <!-- Ejercicio -->
            <div class="mb-3">
                <app-cbo-ejercicio [grupoMuscularId]="selectedGrupoMuscular ?? null" formControlName="idEjercicio"
                    (valueChange)="onEjercicioChange($event)"></app-cbo-ejercicio>
            </div>

            <!-- Botón de búsqueda -->
            <div class="d-flex justify-content-center">
                <button type="submit" class="btn btn-success" [disabled]="!exerciseForm.valid">
                    <i class="fas fa-search"></i>
                    Buscar Ejercicio
                </button>
            </div>
        </form>
    </div>

    <!-- Resultados de la búsqueda -->
    <div class="content-section" *ngIf="exerciseForm.get('nombre')?.value">
        <div class="results-section">
            <h2 class="section-title">
                <i class="fas fa-dumbbell"></i>
                Información del Ejercicio
            </h2>

            <!-- Mostrar el nombre del ejercicio -->
            <div class="mb-4">
                <label class="form-label">Nombre del ejercicio:</label>
                <h3 class="nombre-ejercicio">{{ exerciseForm.get('nombre')?.value }}</h3>
            </div>

            <!-- Mostrar la descripción del ejercicio -->
            <div class="mb-4">
                <label class="form-label">Descripción:</label>
                <div class="descripcion-ejercicio">{{ exerciseForm.get('descripcion')?.value }}</div>
            </div>

            <!-- Mostrar las imágenes del ejercicio -->
            <div class="mb-4">
                <label class="form-label">Imágenes de referencia:</label>
                <div class="row images-grid">
                    <div class="col-md-4 mb-3">
                        <div class="card image-card"
                            (click)="openImageModal(exerciseForm.get('img_1')?.value, 'Imagen 1')"
                            [class.clickable]="exerciseForm.get('img_1')?.value && exerciseForm.get('img_1')?.value !== 'images/rat.jpeg'">
                            <img [src]="exerciseForm.get('img_1')?.value || 'images/rat.jpeg'" class="card-img-top"
                                alt="Imagen 1">
                            <div class="image-overlay"
                                *ngIf="exerciseForm.get('img_1')?.value && exerciseForm.get('img_1')?.value !== 'images/rat.jpeg'">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card image-card"
                            (click)="openImageModal(exerciseForm.get('img_2')?.value, 'Imagen 2')"
                            [class.clickable]="exerciseForm.get('img_2')?.value && exerciseForm.get('img_2')?.value !== 'images/rat.jpeg'">
                            <img [src]="exerciseForm.get('img_2')?.value || 'images/rat.jpeg'" class="card-img-top"
                                alt="Imagen 2">
                            <div class="image-overlay"
                                *ngIf="exerciseForm.get('img_2')?.value && exerciseForm.get('img_2')?.value !== 'images/rat.jpeg'">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card image-card"
                            (click)="openImageModal(exerciseForm.get('img_3')?.value, 'Imagen 3')"
                            [class.clickable]="exerciseForm.get('img_3')?.value && exerciseForm.get('img_3')?.value !== 'images/rat.jpeg'">
                            <img [src]="exerciseForm.get('img_3')?.value || 'images/rat.jpeg'" class="card-img-top"
                                alt="Imagen 3">
                            <div class="image-overlay"
                                *ngIf="exerciseForm.get('img_3')?.value && exerciseForm.get('img_3')?.value !== 'images/rat.jpeg'">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mostrar el enlace del video -->
            <div class="mb-3" *ngIf="exerciseForm.get('link_video')?.value">
                <label class="form-label">Video demostrativo:</label>

                <!-- Video normal (16:9) -->
                <div class="video-container" *ngIf="!currentVideoIsShort">
                    <div class="embed-responsive embed-responsive-16by9">
                        <iframe class="embed-responsive-item" [src]="getSafeUrl(exerciseForm.get('link_video')?.value)"
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>

                <!-- YouTube Short (vertical 9:16) -->
                <div class="video-container short" *ngIf="currentVideoIsShort">
                    <div class="embed-short">
                        <iframe [src]="getSafeUrl(exerciseForm.get('link_video')?.value)" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" *ngIf="showModal" (click)="onModalBackdropClick($event)">
        <div class="modal-content">
            <button type="button" class="close-button" (click)="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <img [src]="selectedImage" alt="{{ selectedImageTitle }}" class="modal-image">
        </div>
    </div>
</div>